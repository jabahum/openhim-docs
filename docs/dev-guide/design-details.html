<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Detailed design using Node.js · OpenHIM</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="**Note:** this design document was written before the development OpenHIM an as such some of the detail have changed or evolved with the OpenHIM&#x27;s continuted development. It is a good starting point but not a complete picture."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Detailed design using Node.js · OpenHIM"/><meta property="og:type" content="website"/><meta property="og:url" content="https://openhim.org/openhim-docs/"/><meta property="og:description" content="**Note:** this design document was written before the development OpenHIM an as such some of the detail have changed or evolved with the OpenHIM&#x27;s continuted development. It is a good starting point but not a complete picture."/><meta property="og:image" content="https://openhim.org/openhim-docs/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://openhim.org/openhim-docs/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/openhim-docs/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/openhim-docs/js/scrollSpy.js"></script><link rel="stylesheet" href="/openhim-docs/css/main.css"/><script src="/openhim-docs/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/openhim-docs/"><h2 class="headerTitle">OpenHIM</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/openhim-docs/docs/introduction/welcome" target="_self">Docs</a></li><li class=""><a href="/openhim-docs/docs/api/introduction/welcome" target="_self">API</a></li><li class=""><a href="/openhim-docs/help" target="_self">Help</a></li><li class=""><a target="_self"></a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Developer Guide</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Introduction<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/introduction/welcome">Welcome</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/introduction/about">About the OpenHIM</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/introduction/key-components">Key Components</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/introduction/roadmap">Roadmap</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/introduction/community">Community</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Installation<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/installation/manual">Install Manually</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/installation/docker">Install via Docker</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/installation/npm">Install via NPM</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/installation/virtual-machine">Install via Virtual Machine</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/installation/console-configuration">Console Configuration</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Tutorial<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/tutorial/prerequisite">Prerequisite</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/tutorial/installation">Installation</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/tutorial/configuration">Configuration</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/tutorial/mediator">Building a Mediator</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">User Guide<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/overview">OpenHIM Overview</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/basic-configuration">Basic configuration</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/adding-users">Adding Users</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/transaction-list">Transaction List</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/alerting-reports">Alerting and reports</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/polling-channels">Polling Channels (scheduled tasks)</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/certificates-keystore">Certificates &amp; Keystore</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/mediators">Mediators</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/sample-disaster-recovery-procedure">Sample disaster recovery procedure</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/openhim-core-versioning-and-compatibility">OpenHIM Core versioning and compatibility</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/user-guide/auditing">Auditing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Developer Guide<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/dev-guide/design-overview">Design overview</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/openhim-docs/docs/dev-guide/design-details">Detailed design using Node.js</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/dev-guide/openhim-development">Getting started with OpenHIM development</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/dev-guide/developing-mediators">Developing mediators</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/dev-guide/restful-api">RESTful API</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/dev-guide/contributing">Contributing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Implementations<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/implementations/datim">DATIM</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/implementations/mhero">mHero</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/implementations/momconnect">MomConnect</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/implementations/openhie">OpenHIE</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">How to<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/setup-and-configure">Setup and configure the OpenHIM</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/openhim-core-release">Create an OpenHIM-core release</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/openhim-console-release">Create an OpenHIM-console release</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/build-centos-rpm-package">Build a CentOS RPM package</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/install-on-centos">Install on CentOS</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/setup-ssl">Setup SSL</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/pre-package-offline-release">Pre-package an offline OpenHIM-core release</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/run-openhim-using-vagrant">Run the OpenHIM using vagrant</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/run-openhim-on-startup">Run the OpenHIM on startup</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/export-import-configuration">Export/import Configuration</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/setup-basic-cluster">Setup a basic cluster</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/manually-install-on-ubuntu-trusty">Manually install on Ubuntu 14.04 Trusty</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/manually-install-on-windows">Manually install on Windows</a></li><li class="navListItem"><a class="navItem" href="/openhim-docs/docs/how-to/build-openhim-documentation">Build the documentation</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Detailed design using Node.js</h1></header><article><div><span><p><strong>Note:</strong> this design document was written before the development OpenHIM an as such some of the detail have changed or evolved with the OpenHIM's continuted development. It is a good starting point but not a complete picture.</p>
<p>Node.js is a good technology option on which to develop the interoperability layer core component for the following reasons:</p>
<ul>
<li>It is very lightweight</li>
<li>It has a robust HTTP library</li>
<li>It has robust support from 3rd party libraries for reading and modifying HTTP requests</li>
<li>It is highly performant</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="libraries-to-use"></a><a href="#libraries-to-use" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Libraries to use</h2>
<ul>
<li><a href="http://koajs.com/">Koa</a> - Koa is a new web application framework for node.js. It provides easy mechanisms to expose web endpoints and process requests and responses in a stack-like approach.</li>
<li><a href="http://passportjs.org/">Passport.js</a> - Middleware to provide authentication mechanisms (in the current implementation this has not yet been used).</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="general-overview"></a><a href="#general-overview" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>General Overview</h2>
<p>The Koa framework provides an easy way to modify HTTP request and responses as they are being processed. Each step that the OpenHIM needs to perform can be written as Koa middleware. Each middleware can handle a different aspect of processing that the OpenHIM need to perform such as authentication, authorization, message persistence and message routing. Developing each of these steps as Koa middleware allows them to be easily reused and allows us to add new steps for future versions. Koa stack approach to processing requests also fit our use case well as it allows the middleware to affect both the request and the response as it is travelling through the system.</p>
<p>The Koa framework also gives us some convenience ctx.request and ctx.response objects that are designed to be used for web applications but they are equally useful for handling web services.</p>
<h2><a class="anchor" aria-hidden="true" id="design"></a><a href="#design" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Design</h2>
<p>The OpenHIM-core will use Koa middleware to act on HTTP requests and Responses. Koa allows you to setup a stack of middleware, each middleware is called in order and gets an opportunity to do something with the request (going down the stack) and is then suspended. Once the end of the stack is reached Koa traverses back up the stack allowing each middleware to do something with the response.</p>
<p>Each row in the diagram representing the OpenHIM-core is a middleware component. Each of the components of the OpenHIM-core will be described further in the following sections. The OpenHIM-core will also have a REST API that will allow a web UI to be created for easy of management.</p>
<p><img src="/_static/design/OpenHIM-js-design.png" alt="openhim-design"></p>
<h2><a class="anchor" aria-hidden="true" id="authentication-and-authorization"></a><a href="#authentication-and-authorization" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Authentication and Authorization</h2>
<p>The are two possible combinations of authentication that the interoperability layer should provide to determine a client's identity:</p>
<ul>
<li>HTTP basic authentication</li>
<li>ATNAs Node Authentication (PKI)</li>
</ul>
<p>Once identify has been established the IL core component should check if that client has the authority to access the requested service.</p>
<p>The HIM should also provide a single-sign-on (SSO) facility to allow users of the HIE management application to have a single identity that they may used to access these applications. To do this the HIM should also act as an openid provider and provide functions to manage SSO users.</p>
<p>The two main workflows that we wish to enable for authentication and authorization are described in the following workflows:</p>
<ul>
<li><a href="https://wiki.ohie.org/display/documents/Common+message+security+workflow">Common message security workflow</a></li>
<li><a href="https://wiki.ohie.org/display/documents/SSO+User+workflow">SSO User workflow</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="authentication"></a><a href="#authentication" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Authentication</h3>
<p>Client details for authentication are stored in the MongoDB database in the following format. Either a password or a certificate (in binary form) is stored in this structure depending on whether the user chooses to use PKI or HTTP basic auth to authenticate clients.</p>
<p>The OpenHIM application should allow new clients to be added and managed with the following details:</p>
<pre><code class="hljs css language-js">{
    <span class="hljs-string">"clientID"</span>: <span class="hljs-string">"Musha_OpenMRS"</span>,
    <span class="hljs-string">"domain"</span>: <span class="hljs-string">"him.jembi.org"</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"OpenMRS Musha instance"</span>,
    <span class="hljs-string">"roles"</span>: [ <span class="hljs-string">"OpenMRS_PoC"</span>, <span class="hljs-string">"PoC"</span> ],
    <span class="hljs-string">"passwordHash"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"cert"</span>: <span class="hljs-string">""</span>
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="basic-auth"></a><a href="#basic-auth" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Basic auth</h4>
<p>When authentication is set to HTTP basic auth then Koa middleware is setup to intercept the request as soon as it enters the HIM as shown above. This middleware will read client details (username and password-hash) out of the MongoDB store to determine if the client can be authenticated. If the client is rejected an error is returned else the request is considered authenticated and is then passed onto the authorization step.</p>
<h4><a class="anchor" aria-hidden="true" id="pki-mutual-tls"></a><a href="#pki-mutual-tls" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PKI - mutual TLS</h4>
<p>When the authentication method is set to PKI then the node http server must be setup to use https and it must be set to trust only clients that have a certificate that it knows of (is stored in a client's details). The domain of a client (identified in its certificate) will be used to map a request received from a client to its details as stored by the OpenHIM (shown above).</p>
<p>To help perform the authentication the <a href="http://passportjs.org/">passport.js</a> module will be used. This provides us with middleware for a number of different authentication schemes. There is also <a href="https://github.com/rkusa/koa-passport">Koa middleware available for passport</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="authorization"></a><a href="#authorization" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Authorization</h3>
<p>The OpenHIM only performs simple authorisation based on the path that is being requested. It should be able to restrict access to certain paths to clients with particular roles. Roles are identified in each client's details. The channel description shown in the router section below shows that each path has one or more allowed roles or clients associated with it. The authorisation component will check if the authenticated client has the authority to access the current path. If authorized the request will be passed on, else, the request will be denied and a HTTP 401 message will be returned.</p>
<h2><a class="anchor" aria-hidden="true" id="message-persistence"></a><a href="#message-persistence" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Message persistence</h2>
<p>Each request and response will be persisted so that it can be logged and so that the erroneous transaction may be re-run. This persistence occurs at two stages. Firstly, once a request is authenticated and authorised and secondly once a response has been received from the external service. All the metadata about a transaction is stored in a single document in MongoDB. The relevant sections are just updated as new information is received. The structure of this information is shown below.</p>
<p>In addition the ability to store orchestration steps exists in the structure. We anticipate exposing a web service to enable mediators to report requests and responses that they make to/receive from external services and have these stored alongside the actual transaction.</p>
<pre><code class="hljs css language-json">{
    "_id": "123",
    "status": "Processing|Failed|Completed",
    "clientID": "Musha_OpenMRS",
    "request": {
        "path": "/api/test",
        "headers": {
            "header1": "value1",
            "header2": "value2"
        },
        "querystring": "param1=value1&amp;param2=value2",
        "body": "&lt;HTTP body&gt;",
        "method": "POST",
        "timestamp": "&lt;ISO 8601&gt;"
    },
    "response": {
        "status": 201,
        "body": "&lt;HTTP body&gt;",
        "headers": {
            "header1": "value1",
            "header2": "value2"
        },
        "timestamp": "&lt;ISO 8601&gt;"
    },
    "routes": [
        {
            "name": "&lt;route name&gt;"
            // Same structure as above
            "request": { ... },
            "response": { ... }
        }
    ]
    "orchestrations": [
        {
            "name": "&lt;orchestration name&gt;"
            // Same structure as above
            "request": { ... },
            "response": { ... }
        }
    ]
    "properties": { // optional meta data about a transaction
        "prop1": "value1",
        "prop2": "value2"
    }
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="router"></a><a href="#router" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Router</h2>
<p>The router allows requests to be forwarded to one or more external services (these could be mediators or an actual HIE component). It does this by allowing the user to configure a number of channels. Each channel matches a certain path and contains a number of routes on which to forward requests. Request may be forwarded to multiple routes however there can only be one <strong>primary route</strong>. The primary route is a the route whose response is returned back to the service requester making use of the OpenHIM.</p>
<p>Channels may be added, removed or updated dynamically as the application is running.</p>
<p>A channel may be access controlled via the 'allow' field. This field will specify a list of users or groups that are allowed to send requests to that channel. If a channel receives a request from an un-authorised source it will return an error.</p>
<p>A custom router will have to be developed that can route according to these rules. The router can be built using the node.js functions provided to make HTTP requests and responses can be relayed using the .pipe() function.</p>
<pre><code class="hljs css language-json">[
    {
        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Some Registry Channel"</span>,
        <span class="hljs-attr">"urlPattern"</span>: <span class="hljs-string">"test/sample/.+"</span>,
        <span class="hljs-attr">"allow"</span>: <span class="hljs-string">"*"</span>,
        <span class="hljs-attr">"routes"</span>: [
            {
                <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Some Registry"</span>,
                <span class="hljs-attr">"path"</span>: <span class="hljs-string">"some/other/path"</span>, <span class="hljs-comment">// this is optional if left out original path is used</span>
                <span class="hljs-attr">"host"</span>: <span class="hljs-string">"localhost"</span>,
                <span class="hljs-attr">"port"</span>: <span class="hljs-number">8080</span>
            }

        ],
        <span class="hljs-attr">"properties"</span>: [ <span class="hljs-comment">// optional meta data about a channel</span>
            { <span class="hljs-attr">"prop1"</span>: <span class="hljs-string">"value1"</span> },
            { <span class="hljs-attr">"prop2"</span>: <span class="hljs-string">"value2"</span> }
        ]
    },
    {
        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Some Registry Channel"</span>,
        <span class="hljs-attr">"urlPattern"</span>: <span class="hljs-string">"test/sample2/.+/test2"</span>,
        <span class="hljs-attr">"allow"</span>: [ <span class="hljs-string">"Alice"</span>,<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"PoC"</span> ],
        <span class="hljs-attr">"routes"</span>: [
            {
                <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Some Registry"</span>,
                <span class="hljs-attr">"host"</span>: <span class="hljs-string">"localhost"</span>,
                <span class="hljs-attr">"port"</span>: <span class="hljs-number">8080</span>,
                <span class="hljs-attr">"primary"</span>: <span class="hljs-literal">true</span>
            },
            {
                <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Logger"</span>,
                <span class="hljs-attr">"host"</span>: <span class="hljs-string">"log-host"</span>,
                <span class="hljs-attr">"port"</span>: <span class="hljs-number">4789</span>
            }
        ],
        <span class="hljs-attr">"properties"</span>: [ <span class="hljs-comment">// optional meta data about a channel</span>
            { <span class="hljs-attr">"prop1"</span>: <span class="hljs-string">"value1"</span> },
            { <span class="hljs-attr">"prop2"</span>: <span class="hljs-string">"value2"</span> }
        ]
    }
]
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="restful-api"></a><a href="#restful-api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Restful API</h2>
<p>The OpenHIM must also expose a restful API that enables it to be configured and to allow access to the logged transactions. This restful API will drive a web application that can allow the OpenHIM to be configured and will allow transactions to be viewed and monitored.</p>
<p>The API must supply CRUD access to the following constructs:</p>
<ul>
<li>transaction logs</li>
<li>transaction channels</li>
<li>client details</li>
</ul>
<p>It should also allow for the following actions:</p>
<ul>
<li>single and batch re-processing of transactions</li>
<li>querying for monitoring statistics</li>
</ul>
<p>The API reference as it currently exists can be <a href="./dev-guide/api-ref.html">found here</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="api-authentication"></a><a href="#api-authentication" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API Authentication</h3>
<p>For details follow the following issue: <a href="https://github.com/jembi/openhim-core-js/issues/57#issuecomment-44835273">https://github.com/jembi/openhim-core-js/issues/57#issuecomment-44835273</a></p>
<p>The users collection should look as follows:</p>
<pre><code class="hljs css language-json">{
    <span class="hljs-attr">"firstname"</span>: <span class="hljs-string">"Ryan"</span>,
    <span class="hljs-attr">"surname"</span>: <span class="hljs-string">"Crichton"</span>,
    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"r..@jembi.org"</span>,
    <span class="hljs-attr">"username"</span>: <span class="hljs-string">"ryan.crichton"</span>,
    <span class="hljs-attr">"passwordHash"</span>: <span class="hljs-string">"xxxxx"</span>,
    <span class="hljs-attr">"passwordSalt"</span>: <span class="hljs-string">"xxxxx"</span>,
    <span class="hljs-attr">"apiKey"</span>: <span class="hljs-string">"fd41f5da-b059-45e8-afc3-99896ee5a7a4"</span>,
    <span class="hljs-attr">"groups"</span>: [ <span class="hljs-string">"Admin"</span>, <span class="hljs-string">"RHIE"</span>]
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/openhim-docs/docs/dev-guide/design-overview"><span class="arrow-prev">← </span><span>Design overview</span></a><a class="docs-next button" href="/openhim-docs/docs/dev-guide/openhim-development"><span class="function-name-prevnext">Getting started with OpenHIM development</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#libraries-to-use">Libraries to use</a></li><li><a href="#general-overview">General Overview</a></li><li><a href="#design">Design</a></li><li><a href="#authentication-and-authorization">Authentication and Authorization</a><ul class="toc-headings"><li><a href="#authentication">Authentication</a></li><li><a href="#authorization">Authorization</a></li></ul></li><li><a href="#message-persistence">Message persistence</a></li><li><a href="#router">Router</a></li><li><a href="#restful-api">Restful API</a><ul class="toc-headings"><li><a href="#api-authentication">API Authentication</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/openhim-docs/" class="nav-home"><img src="/openhim-docs/img/favicon.ico" alt="OpenHIM" width="66" height="58"/></a><div><h5>Docs</h5><a href="/openhim-docs/docs/en/doc1.html">Getting Started (or other categories)</a><a href="/openhim-docs/docs/en/doc2.html">Guides (or other categories)</a><a href="/openhim-docs/docs/en/doc3.html">API Reference (or other categories)</a></div><div><h5>Community</h5><a href="/openhim-docs/en/users.html">User Showcase</a><a href="https://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://discordapp.com/">Project Chat</a><a href="https://twitter.com/" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/openhim-docs/blog">Blog</a><a href="https://github.com/">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="https://opensource.facebook.com/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/openhim-docs/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2019 Your Name or Your Company Name</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'my-api-key',
                indexName: 'my-index-name',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>