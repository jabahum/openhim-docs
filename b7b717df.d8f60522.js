(window.webpackJsonp=window.webpackJsonp||[]).push([[186],{321:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return c})),r.d(t,"metadata",(function(){return s})),r.d(t,"rightToc",(function(){return l})),r.d(t,"default",(function(){return u}));var n=r(1),a=r(9),o=(r(0),r(382)),i=r(388),c={id:"orchestrator",title:"Building a basic Orchestrator Mediator",sidebar_label:"Orchestrator Mediator",keywords:["mediator","tutorial","orchestrator"],description:"Detailed tutorial on creating a basic Orchestrator OpenHIM Mediator"},s={id:"tutorial/mediators/orchestrator",title:"Building a basic Orchestrator Mediator",description:"Detailed tutorial on creating a basic Orchestrator OpenHIM Mediator",source:"@site/docs/tutorial/mediators/orchestrator.md",permalink:"/docs/next/tutorial/mediators/orchestrator",version:"next",sidebar_label:"Orchestrator Mediator",sidebar:"docs",previous:{title:"Building a Basic Mediator",permalink:"/docs/next/tutorial/mediators/basic-scaffold"},next:{title:"Building a Skeleton Production Mediator",permalink:"/docs/next/tutorial/mediators/production-scaffold"}},l=[{value:"Useful Links",id:"useful-links",children:[]},{value:"Introduction",id:"introduction",children:[]},{value:"Prerequisites",id:"prerequisites",children:[]},{value:"OpenHIM Mediator Setup",id:"openhim-mediator-setup",children:[{value:"Step 1 - Preparing the Scaffold Mediator to be used for the Orchestrator",id:"step-1---preparing-the-scaffold-mediator-to-be-used-for-the-orchestrator",children:[]}]}],p={rightToc:l};function u(e){var t=e.components,r=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},p,r,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"TLDR; Watch Linux Tutorial Setup on ",Object(o.b)("a",Object(n.a)({parentName:"strong"},{href:"https://www.youtube.com/watch?v="}),"YouTube"))),Object(o.b)("h2",{id:"useful-links"},"Useful Links"),Object(o.b)("p",null,Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/jembi/openhim-mediator-bootstrap-orchestrator"}),"OpenHIM Orchestrator Bootstrap Mediator")),Object(o.b)("h2",{id:"introduction"},"Introduction"),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"Tutorial Purpose: Create an Orchestrator OpenHIM Mediator registered with your local OpenHIM instance that illustrates how to implement your own custom mediator logic.")),Object(o.b)("p",null,"In this tutorial we will be designing an orchestrator mediator that will accept a request from the client for a list of Health Facilities. In our example, the client wants the facility list in JSON format. ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.dhis2.org/2.28/en/user/html/ch02s02.html"}),"DHIS2")," is the source of our facility data and in this example only provides the data in XML. Therefore, our mediator will have to translate the data from XML into JSON before sending the response back to the client."),Object(o.b)("img",{alt:"Mediator Diagram",src:Object(i.a)("img/tutorial/mediatorDiagram.jpg")}),Object(o.b)("h2",{id:"prerequisites"},"Prerequisites"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"NodeJS and NPM")),Object(o.b)("p",null,"This tutorial assumes you've setup the OpenHIM and understand the basics of an openHIM Mediator."),Object(o.b)("p",null,"Having a solid understanding of ExpressJS and Javascript ES6 syntax is advised."),Object(o.b)("hr",null),Object(o.b)("h2",{id:"openhim-mediator-setup"},"OpenHIM Mediator Setup"),Object(o.b)("h3",{id:"step-1---preparing-the-scaffold-mediator-to-be-used-for-the-orchestrator"},"Step 1 - Preparing the Scaffold Mediator to be used for the Orchestrator"),Object(o.b)("p",null,"We will use the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/jembi/openhim-mediator-bootstrap-scaffold"}),"OpenHIM Bootstrap Scaffold Mediator")," from the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/jembi/openhim-mediator-tutorial/blob/master/1_Scaffold_OpenHIM_Mediator.md"}),"previous tutorial")," as the starting point for the orchestrator."),Object(o.b)("p",null,"To keep the two mediators from conflicting, the first thing we need to change for the orchestrator is the port numbers. Let's configure the ",Object(o.b)("inlineCode",{parentName:"p"},"Orchestrator")," to expose port 3001 ",Object(o.b)("em",{parentName:"p"},"instead")," of 3000 so that the two mediators can run at the same time. The files that set the port numbers are: ",Object(o.b)("inlineCode",{parentName:"p"},"index.js"),", ",Object(o.b)("inlineCode",{parentName:"p"},"Dockerfile"),", and ",Object(o.b)("inlineCode",{parentName:"p"},"mediatorConfig.json"),"."),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"//index.js\napp.listen(3001, () => {\n  console.log('Server listening on port 3001...')\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),"#Dockerfile\nEXPOSE 3001\n")),Object(o.b)("p",null,"The last change is in the mediatorConfig.json and package.json files. Where ever the word scaffold was used replace this with ",Object(o.b)("strong",{parentName:"p"},"orchestrator"),". Your ",Object(o.b)("inlineCode",{parentName:"p"},"mediatorConfig")," file should now resemble this:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-json"}),'{\n  "urn": "urn:mediator:tutorial_orchestrator",\n  "version": "1.0.0",\n  "name": "Orchestrator Mediator",\n  "description": "Tutorial Orchestrator Mediator",\n  "defaultChannelConfig": [\n    {\n      "name": "Bootstrap Orchestrator Mediator",\n      "urlPattern": "^/orchestrator$",\n      "routes": [\n        {\n          "name": "Bootstrap Orchestrator Mediator Route",\n          "host": "orchestrator",\n          "path": "/",\n          "port": "3001",\n          "primary": true,\n          "type": "http"\n        }\n      ],\n      "allow": ["admin"],\n      "methods": ["GET", "POST"],\n      "type": "http"\n    }\n  ],\n  "endpoints": [\n    {\n      "name": "Bootstrap Orchestrator Mediator Endpoint",\n      "host": "orchestrator",\n      "path": "/",\n      "port": "3001",\n      "primary": true,\n      "type": "http"\n    }\n  ],\n  "configDefs": [\n    {\n      "param": "tutorial",\n      "displayName": "Tutorial variables",\n      "description": "Some variables to demonstrate fetching OpenHIM mediator config",\n      "type": "struct",\n      "array": false,\n      "template": [\n        {\n          "param": "variable_1",\n          "displayName": "Variable 1",\n          "description": "First Variable",\n          "type": "string"\n        },\n        {\n          "param": "variable_2",\n          "displayName": "Variable 2",\n          "description": "Second Variable",\n          "type": "string"\n        }\n      ]\n    }\n  ]\n}\n')),Object(o.b)("p",null,"Test the new project by building the image, get the docker network name, and start the container:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"docker build -t orchestrator .\n\ndocker network ls\n\ndocker run --network {openhim-network} -p 3001:3001 --name orchestrator --rm orchestrator\n")),Object(o.b)("p",null,"Open up the OpenHIM Console Mediators page in a browser and you should see your new mediator listed."),Object(o.b)("img",{alt:"Registered Orchestrator Mediator",src:Object(i.a)("img/tutorial/registerOrchestrator.png")}),Object(o.b)("p",null,"Important mediator changes are indicated in the following image. Once your orchestrator mediator is properly configured click the green ",Object(o.b)("strong",{parentName:"p"},"Add channel")," button in the bottom right corner."),Object(o.b)("img",{alt:"Important Orchestrator Details",src:Object(i.a)("img/tutorial/orchestratorDetails.png")}),Object(o.b)("p",null,"On the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"http://localhost:9000/#!/channels"}),"OpenHIM Console Channels")," page you should see your new orchestrator channel."),Object(o.b)("img",{alt:"Orchestrator Channel",src:Object(i.a)("img/tutorial/addOrchestratorChannel.png")}),Object(o.b)("p",null,"Click the yellow edit channel icon to view details of the channel. Go to the ",Object(o.b)("strong",{parentName:"p"},"Route")," tab and check that the host value is ",Object(o.b)("inlineCode",{parentName:"p"},"orchestrator")," and the port is ",Object(o.b)("strong",{parentName:"p"},"3001"),"."),Object(o.b)("img",{alt:"Orchestrator Route Details",src:Object(i.a)("img/tutorial/orchestratorRouteDetails.png")}))}u.isMDXComponent=!0},382:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return h}));var n=r(0),a=r.n(n);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=a.a.createContext({}),p=function(e){var t=a.a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):c({},t,{},e)),r},u=function(e){var t=p(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},b=Object(n.forwardRef)((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),u=p(r),b=n,h=u["".concat(i,".").concat(b)]||u[b]||d[b]||o;return r?a.a.createElement(h,c({ref:t},l,{components:r})):a.a.createElement(h,c({ref:t},l))}));function h(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=b;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:n,i[1]=c;for(var l=2;l<o;l++)i[l]=r[l];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,r)}b.displayName="MDXCreateElement"},387:function(e,t,r){"use strict";var n=r(0),a=r(53);t.a=function(){return Object(n.useContext)(a.a)}},388:function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));r(389);var n=r(387);function a(e){var t=(Object(n.a)().siteConfig||{}).baseUrl,r=void 0===t?"/":t;if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?r+e.slice(1):r+e}},389:function(e,t,r){"use strict";var n=r(20),a=r(36),o=r(390),i="".startsWith;n(n.P+n.F*r(391)("startsWith"),"String",{startsWith:function(e){var t=o(this,e,"startsWith"),r=a(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),n=String(e);return i?i.call(t,n,r):t.slice(r,r+n.length)===n}})},390:function(e,t,r){var n=r(75),a=r(25);e.exports=function(e,t,r){if(n(t))throw TypeError("String#"+r+" doesn't accept regex!");return String(a(e))}},391:function(e,t,r){var n=r(2)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(r){try{return t[n]=!1,!"/./"[e](t)}catch(a){}}return!0}}}]);